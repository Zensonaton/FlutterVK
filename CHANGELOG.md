<!-- markdownlint-disable MD033 -->

# Flutter VK vTODO

<!-- Изменения с других Pre-release версий, которые должны быть отображены в non-pre версии:

**Важное предупреждение**: это **бета-обновление**, содержащее в себе немало технических изменений. Сейчас приложение находится в частично "поломанном" состоянии. Обновляйтесь только в том случае, если и вправду понимаете, что делаете. Вам, вероятнее всего, придётся откатиться до [предыдущей версии Flutter VK](https://github.com/Zensonaton/FlutterVK/releases) если Вы хотите стабильной работы приложения. **Сейчас очень много всего в приложении поломано**, и я это знаю. К примеру, такие вещи, как открытие плейлистов, кэширование, получение текстов песен и прочего целиком и полностью поломано.

Это обновление привносит в себя огромное техническое изменение: Переход от одной библиотеки для state-менеджмента, [`provider`](https://pub.dev/packages/provider) к другой, [`riverpod`](https://pub.dev/packages/riverpod) и [`flutter_hooks`](https://pub.dev/packages/flutter_hooks), а так же библиотека [`go_router`](https://pub.dev/packages/go_router) для реализации навигации между страницами.

К сожалению, эти технические изменения почти что не видны обычному пользователю, однако они были нужны ради стабильной работы приложения, а так же различных оптимизаций. Однако, несмотря на это, обновление привнесло некоторые изменения интерфейса и прочих функций.

## Изменения

- Новая реализация экрана плейлиста.
- Перепись `CachedStreamAudioSource`.
- Обработчики случаев, когда плеер запускал не/кэшированный трек (`ExtendedAudio.isCached`), с/без кэша (`File.exists()`).
- Использование другой структуры папок для треков.
- Избавление от лишних библиотек `media_kit` для Android. Размер приложения уменьшился с ~42 МБ до ~15 МБ.
- Использование более простых операций сравнения плейлистов.
- Небольшое уведомление при установке бета-версии приложения.
- Установка бета-версии приложения теперь автоматически устанавливает бета-канал в настройках.
- Система миграций БД.
- Избавление от ненужных полей в БД.
- Удалил лишние ключи локализации, связанных с предупреждением об оповещении API ВК о прослушивании трека.
- Кнопка "показать список изменений" на экране профиля.
- Увеличение разрешения изображения плейлистов.
- Изменение текста для playlists viewer.
- Обработчик ошибок VK API вместо множества вызовов `raiseOnAPIError`.
- Избавление от лишних `compute` при парсинге JSON в классы.
- Установка `access_token` при помощи Dio Interceptor'ов.
- Избавление от методов `callVkAPI`.
- Поддержка `gzip` для API-запросов, дающий сжатие API-запросов в ~30%.
- Debug-кнопка для бенчмаркинга API-запроса.
- Хранение размера кэшированного трека в БД.
- Категория "визуал" теперь находится выше "музыкального плеера" на экране профиля.
- Запрос на получение уведомлений при запуске приложения.
- Система защиты от downgrade'а БД.
- Изображения того, что сейчас загружается на экране загрузок.
- Избавление от свечения на экране загрузки у раздела "загружено ранее".
- Избавление от жирного текста у `@username` на экране профиля.
- Увеличение расстояния от названия раздела до содержимого на экране профиля для мобильного интерфейса.
- Отключение показа длительности трека и его кэша на главном экране при мобильном интерфейсе.
- Избавление от анимации размера плеера при Desktop Layout'е.
- Логирование слишком долгой загрузки данных с БД.
- Изменение настройки "тип палитры цветов обложки" теперь изменяет цвета интерфейса мгновенно.
- Реализация системы кэширования плейлистов.
- Кнопка "тип палитры цветов обложки" теперь отключена, если рекомендации не подключены.
- Система для менеджмента загрузок.
- Избавление от старой и неработающей системы кэширования плейлистов.
- Избавление от лишних Repaint'ов благодаря `RepaintBoundary`.
- Кэширование цветов обложек в БД.
- Отображение недоступных треков.
- Вместо ID пользователя отображается его `@username` в профиле.
- Перепись экрана профиля с целью уменьшения количества повторения кода.
- Изменение вида настроек на экране профиля.
- Иконка открытия диалога возле кнопок на экране профиля.
- Изменение названий и описаний у многих настроек для упрощения читабельности.
- Настройка "OLED-тема" теперь отключается, если включена светлая тема.
- Настройка "debug-логирование плеера" теперь отображено лишь на desktop-платформах.
- Пересмотр значений по-умолчанию у настроек.
- Избавление от функционала загрузки треков из Spotify ввиду ограничений со стороны сервера без premium-подписки.
- Возвращение функции "экспорт списка треков".
- Логирование ошибок Provider'ов.
- Новая настройка: "Тип палитры цветов обложки".
- Новое сообщение для README-файла, располагаемый в папке с кэшированными треками.
- Более правильный цвет у "свечения" обложек треков в мини и полноэкранном плееров.
- Своя реализация для получения цветов обложки трека, использующая Isolate где это возможно.
- Избавление от `WelcomeDialog` при авторизации.
- Избавление от `PhotoMaxOrig` ввиду ненадобности.
- Изменение текста для диалога "подключение рекомендаций".
- Избавление от диалога, спрашивающего разрешение на отправку статистики о прослушивании треков.
- Игнорирование ошибки "какой сейчас вайб не был найден".
- Управление плеером теперь использует toggle'ы вместо `!state`.
- Уменьшение количества вызовов `setState` от плеера.
- Удаление настройки "Точный алгоритм цветов плеера".
- Проверка на соответствие ID пользователей ВК при вторичной авторизации.
- Некоторые из кнопок (лайк, дизлайк) вместо полноэкранной анимации загрузки теперь отображают загрузку в самой кнопке.
- Настройка для debug-логирования плеера.
- Длительность треков теперь не отображается в разделе "Совпадения по вкусам".
- Lottie-анимация у VK Mix теперь отображается лишь во время воспроизведения.
- Адекватный Skeleton-loader для VK Mix.
- Система для логирования крашей и других проблем приложения.
- Долгое нажатие на кнопку "паузы" в мини-плеере снизу теперь его насильно останавливает.
- Изменение текста для `WelcomeRoute`.
- Избавление от показа длительности трека на экране плейлиста.
- Улучшения производительности на экране плейлиста.
- Сохранение состояние Shuffle при его переключении через уведомление на OS Android.
- Избавление от старого кода для кэширования для `audio_player`.
- Использование seek-событий вместо position при обновлении уведомления.
- Глобальный поиск и экран "тип палитры цветов обложки" теперь не использует кэшированные изображения.
- Визуальные изменения экрана обновления.
- Кнопка "показать прогресс" при запуске загрузки обновления.
- Использование асинхронных методов для сохранения файлов.
- Хранение всех категорий API методов ВКонтакте в классе `VKAPI`.
- Миграция с `http` на `dio`.
- У `Thumbnails` класса теперь значения не могут быть null.
- Оптимизации, а так же удаление костылей связанных с массовым получением альбомов.
- Избавление от анимации появления изображения трека.
- Использование `/welcome` как go_route вместо `/`.
- Оптимизации.

## Фиксы

- Фикс цветов приложения.
- Фикс OLED-темы.
- Фикс иконки настройки "канал обновлений".
- Фикс появления кнопки "В реальном времени" если не подключены рекомендации ВК.
- Фикс выхода из аккаунта, если нету папки с треками.
- Фикс появления плейлистов из раздела "в реальном времени" в виде Skeleton-loader'ов.
- Фикс входа в приложение ввиду SSL-сертификатов.
- Фикс различных багов интерфейса, связанных с закрытием плеера.
- Фикс запуска приложения.
- Фикс авторизации.
- Фикс цветов "сердечек" у `AudioTrackTile`.
- Фикс иконки у раздела "музыка".
- Фикс цветов для диалога "тип палитры цветов обложки".
- Фикс иконки для диалога "Канал обновлений".
- Фикс запуска неправильного трека.
- Фикс overflow'а на экране с музыкой.
- Фикс отсутствия анимации паузы при полноэкранном мобильном плеере.
- Фикс не переключающегося активного трека на экране плейлиста.
- Фикс появления надписи "Подключить рекомендации ВКонтакте" когда они подключены.
- Фикс возобновления паузы из-за функции "пауза при минимальной громкости".
- Фикс повторного создания `stopOnPause`-таймера.
- Фикс сильно выделяющейся иконки Explicit.
- Фикс отображения переключения shuffle в мини-плеере.
- Фикс загрузки текстов песен с ВКонтакте.
- Фикс неизменяющегося мини-плеера при изменении треков.
- Фикс возможности скроллить текст skeleton loader текста песни в Desktop Layout'е при полноэкранном плеере, а так же эффект fade'а для него.
- Фикс текста в диалоге "тип палитры цветов обложки".
- Фикс работы `FadingListView`.
- Фикс иконки лайка на экране поиска.
- Фикс сохранения плейлиста "результаты поиска" в БД.
- Фикс отображения лайка с других плейлистов.
- Фикс ошибки, связанной с методом `_silentSetPlaylist`.
- Фикс измения размера надписи "Добро пожаловать" на главном экране.
- Фикс необновляющегося полноэкранного плеера.
- Фикс повторной загрузки обновления, если файл обновления уже существует.
- Фикс бага, из-за которого при обновлении данных плейлиста он перемещался в списке плейлистов.
- Фикс вызова `stop` у плеера ввиду ошибок.
- Фикс склонения текста на экране загрузок.
- Фикс мигающих обложек раздела "совпадения по вкусам" при переключении между треками.
- Фикс работы кнопки "воспроизвести все" на главном экране.
- Фикс `Download error` при попытке кэшировать некоторые треки.
- Фикс неправильно отображающейся надписи с длительностью треков в плейлисте.
- Фикс padding'а для мини-плеера при Mobile Layout'е.
- Фикс времени на экране обновления.
- Фикс бага, из-за которого экран с плейлистами не обновлялся.
- Фикс необновляющегося уведомления на OS Android.
- Фикс зависания приложения из-за остановки плеера.
- Фикс смещения текста на экране плейлиста у треков.
- Фикс бага на Android, из-за которого треки играли с самого начала после перемотки.
- Фикс открытия экрана с деталями трека зажатием пальца.
- Фикс "застрявшего" прогресса воспроизведения при переключении между треками.
- Фикс невозможности запустить воспроизведение плейлиста на ПК нажатием по центру.
- Фикс запуска других плейлистов после запуска VK Mix.
- Фикс цветов экрана плейлиста.
- Фикс необновляющегося названия плейлиста.
- Фикс отображения текстов песен при Mobile Layout.

-->
